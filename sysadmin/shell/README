How to use:

++ OS Installation ++

1) Install Debian Wheezy base system, use host name "gold", domain
name "corp.example.com";

$ cat /etc/hostname
gold
$ cat /etc/hosts
127.0.0.1   localhost
127.0.1.1   gold.corp.example.com gold

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters


++ Network Configuration ++

2) Use static network configuration in /etc/network/interfaces:

iface eth0 inet static
    address 10.0.0.10
    netmask 255.255.255.0
    gateway 10.0.0.1

Setup /etc/resolv.conf:
$ cat /etc/resolv.conf
nameserver 8.8.8.8
nameserver 8.8.4.4

NOTICE: If you DON'T use 10.0.0.10 for the "gold" server, adjust ./etc/bind/db.{corp,10}.


++ Service Installation ++

3) Run ./run.sh as root user, it may fail, fix errors and run ./run.sh
again until all are OK.

$ cat /etc/resolv.conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
search corp.example.com
nameserver 127.0.0.1
# for failover in case bind9 on 127.0.0.1 is not available
#nameserver 8.8.8.8
#nameserver 8.8.4.4


++ OpenLDAP Configuration ++

4) As root, run:
    # service slapd start
    # ldapmodify -Y EXTERNAL -H ldapi:/// -c -f ldap-mods.ldif
    # service slapd restart


++ Kerberos Configuration ++

5.1) Create Kerberos users (*/ldap are administrators of OpenLDAP server):
    # kadmin.local
    kadmin.local: addprinc -policy user dieken
    kadmin.local: addprinc -policy user jack
    kadmin.local: addprinc -policy admin dieken/ldap

5.2) Suppose "dieken" is the first local normal user with uid=1000,
     "jack" is a user stored in OpenLDAP, run these commands as root
     to create system user "jack"

    # kinit dieken/ldap
    # /usr/sbin/ldapinit
    # /usr/sbin/ldapaddgroup users
    # /usr/sbin/ldapadduser jack users
    # kdestroy
    # getent passwd | grep jack


++ Exim Configuration ++

6) Run /usr/share/doc/exim4-base/examples/exim-gencert to generate
certificates for Exim if you can't get CA issued certificates, the
"Server name" must be "smtp.corp.example.com".

    ## Dovecot >= 2.0.18, due to these patches:
    ## http://hg.dovecot.org/dovecot-2.0/rev/bed15faedfd4 auth: Check also masterdbs when checking if auth mechanism can be used.
    ## http://hg.dovecot.org/dovecot-2.0/rev/525a179f324f auth: DIGEST-MD5 didn't read nonce-count parameter correctly.
    ## http://hg.dovecot.org/dovecot-2.0/rev/847ca219989d auth: DIGEST-MD5 supports authorization id now.

++ Mailman Configuration ++

7.1) Run "newlist mailman" as root

Optional:
    You may want to fix broken mailing list url if you have lists created before:
        http://mail.python.org/pipermail/mailman-users/2008-January/060106.html
        The with_list script: # withlist -l -r fix_url LISTNAME -u NEW-DOMAIN
        For example: # withlist -l -r fix_url mailman --urlhost list.corp.example.com

        http://mail.python.org/pipermail/mailman-users/2002-September/022781.html
        The config_list script.

    And you may have to modify these files manually to fix bad links:
    /var/lib/mailman/archives/public/mailman/index.html
    /var/lib/mailman/archives/private/mailman/index.html

7.2) Run "mmsitepass" as root, it's required to create new list on mailman Web UI.

7.3) Fix file permission:
# chown www-data:list /var/lib/mailman/archives/private
# chgrp -R list /var/lib/mailman/archives/private

7.3) Restart apache2 and mailman services.


++ Darwin CalendarServer Configuration ++

8) The file system where /var/spool/davcald sits must be mounted with
"user_xattr" option enabled.


++ DAViCal Configuration ++

9) Turn off "Require valid-user" in /etc/apache2/sites-enabled/davical
and restart Apache, then run this command as root user to find out
admin's default password:
    # su postgres -c "psql davical -c 'select username, password from usr;'"
    (the password is the bit after the '**' in the 'password' field)

Login http://cal.corp.example.com/ with "admin" account, create a user
for your Kerberos account, for example, dieken@CORP.EXAMPLE.COM

Turn on "Require valid-user" again, restart Apache, use Firefox to
access http://cal.corp.example.com/, if you have setup Negotiate
authentication for your Firefox browser, you will find you can login
without password.


++ Mantis Configuration ++

10) Access "http://bug.corp.example.com/admin/install.php" to finish
installation, you don't have to input anything in the input fields,
just click the "Install/Upgrade Database" button.

Notice the default admin account is "administrator" with password "root".

You may need to adjust default timezone in /etc/php5/cgi/php.ini:
    date.timezone = Asia/Chongqing
See http://php.net/manual/en/function.date-default-timezone-set.php


++ Bugzilla Configuration ++

11) Run these commands as root:
    # cd /srv/www/bugzilla
    # ./checkinstall.pl


++ Foswiki Configuration ++

12.1) Optional, run these commands to install optional modules:
    # cd /srv/www/foswiki/bin
    # ../tools/dependencies_installer.pl
    # chown -R www-data:www-data /srv/www/foswiki

12.2) Optional, the formal way to install NormalizeUserPlugin, this
      will install NormalizeUserPlugin.txt to data/ too.

    Build NormalizeUserPlugin:
        $ wget ..../Foswiki-1.1.4.tgz
        $ wget ..../BuildContrib.tgz
        $ tar xf Foswiki-1.1.4.tgz
        $ cd Foswiki-1.1.4
        $ ln -s . core
        $ tar xf ../BuildContrib.tgz
        $ cp -a ../contrib/NormalizeUserPlugin .
        $ perl build.pl NormalizeUserPlugin release

    Install NormalizeUserPlugin:
        $ cp NormalizeUserPlugin/NormalizeUserPlugin_installer /tmp
        $ cp NormalizeUserPlugin/NormalizeUserPlugin.tgz /tmp
        $ su www-data
        $ cd /srv/www/foswiki
        $ /tmp/NormalizeUserPlugin_installer -a -r -c install

12.3) add your user name to "admin" group in /srv/www/foswiki/data/admin-group:

admin: dieken@CORP.EXAMPLE.COM

Restart Apache, access http://wiki.corp.example.com/bin/configure .


++ MoinMoin Configuration ++

13) Access http://moin.corp.example.com/LanguageSetup to install
    language pack, then restart Apache service.


=============================================================
Firefox and ThunderBird settings:

1) Thunderbird: Edit -> Preferences -> Advanced -> Config Editor
            or  Tools -> Options -> Advanced -> Config Editor
   Firefox: input "about:config" in URL box and press Enter key

    network.negotiate-auth.trusted-uris: corp.example.com

2) Thunderbird
    IMAP:
        Server Name: imap.corp.example.com
        Port: 143
        User Name: dieken
        Connection security: STARTTLS
        Authentication method: Kerberos / GSSAPI
    SMTP:
        Server Name: smtp.corp.example.com
        Port: 25
        User Name: dieken
        Connection security: STARTTLS
        Authentication method: Kerberos / GSSAPI

3) Lightning
  Darwin CalendarServer:
    http://calendar.corp.example.com/calendars/users/dieken/calendar/
  DAViCal:
    http://cal.corp.example.com/caldav.php/dieken@CORP.EXAMPLE.COM/calendar/


=============================================================
Issues:

If you encounter this error, check whether the keytab file exists
and is readable by slapd.
    $ ldapwhoami
    SASL/GSSAPI authentication started
    ldap_sasl_interactive_bind_s: Other (e.g., implementation specific) error (80)
            additional info: SASL(-1): generic failure: GSSAPI Error: Unspecified GSS failure.  Minor code may provide more information (Unknown error)


If Kerberos authentication fails, check:
  (1) Is service key in xxx.keytab?
  (2) Is xxx.keytab readable?
  (3) Has the service been restarted after xxx.keytab is changed?


=============================================================
Reference:

Shorewall       http://shorewall.net/

Kerberos        http://web.mit.edu/kerberos/
                http://techpubs.spinlocksolutions.com/dklar/kerberos.html

Cyrus SASL      http://www.cyrusimap.org/docs/cyrus-sasl/

OpenLDAP        http://www.openldap.org/
                http://techpubs.spinlocksolutions.com/dklar/ldap.html

Bind 9          http://www.isc.org/software/bind/documentation

Exim 4          http://wiki.debian.org/PkgExim4
                http://www.exim.org/
                http://www.jcdigita.com/eximconfig/
                /usr/share/doc/exim4-base/README.Debian.gz
                apropos exim

Dovecot         http://dovecot.org/
                http://wiki2.dovecot.org/Pigeonhole/Sieve
                http://wiki2.dovecot.org/Pigeonhole/ManageSieve

Web SSO         http://webauth.stanford.edu/features.html
                https://wiki.jasig.org/display/CAS/Kerberos
                http://www.umich.edu/~umweb/downloads/WebSSOImplementationComparision.pdf
                http://www.jisc.ac.uk/uploaded_documents/CMSS-Gilmore.pdf
                http://et.aset.psu.edu/publications/2003/WebSSO.shtml

SPNEGO          http://mbechler.eenterphace.org/blog/index.php?/archives/6-Doing-GSSNegotiate-SSO-using-Mozilla-Firefox,-MIT-Kerberos-and-PHP.html
                https://developer.mozilla.org/En/Integrated_Authentication
                http://publib.boulder.ibm.com/infocenter/wasinfo/v6r1/index.jsp?topic=%2Fcom.ibm.websphere.base.doc%2Finfo%2Faes%2Fae%2Ftsec_SPNEGO_config_web.html

                http://dev.chromium.org/developers/design-documents/http-authentication
                http://code.google.com/p/chromium/issues/detail?id=28282
                http://code.google.com/p/chromium/issues/detail?id=50065
                http://www.google.com/support/forum/p/Chrome/thread?tid=28894030e871cb94&hl=en
                http://blob.inf.ed.ac.uk/gdutton/2010/11/chrome-and-spnego/
                http://code.google.com/p/chromium/issues/detail?id=50415

                http://linsec.ca/blog/2011/07/26/kerberos-on-os-x-10-7-lion/

MantisBT        http://www.eiben.weite-welt.com/2010/07/integrated-windows-authentication-in-mantis-updated-to-mantis-1-2-1/

=============================================================
Resource:

Free SSL certificate:   http://cert.startcom.org/

