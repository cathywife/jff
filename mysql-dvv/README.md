# Dotted version vector for MySQL 5.7

## Purpose

The SQL script is to add logical clock support for MySQL 5.7 like
[Riak](http://basho.com/products/riak-kv/), to avoid silent data loss
under these two scenarios although technically they are same:

* In single data center, asynchronous replication between master and
  slave nodes lags and failover happends, new requests update stale data.

  With DVV support, we can do failover as soon as possible, don't have to
  wait the slave to catch up because often most records are already
  replicated successfully and newly data are possibly not to be updated
  again very soon.

* Between multiple data centers, asynchronous replication between
  master and slave nodes lags and failover happends, new requests update
  stale data.

  In a master-master multi-center deployment, the users are routed to
  different data center very soon whenever one data center is down, thus
  we get fully high availabilty and eventual consistency.

## Usage

### Setup MySQL tables

The script is tested on Oracle MySQL 5.7.12, check the commented SQL
CREATE TABLE clauses in it to learn how to enhance your domain model
table. Basically you need these steps:

1. The domain model must have some unique key to identify records,
   usually this is its primary key.
2. The domain model must have two columns `deleted` and `logicalClock`,
   it's best to put `logicalClock` at the end due to its variable length.
3. In the same database there must be a sibling table `<SomeTable>__sibling`
   that has same data structure with your domain model except changing
   primary key to regular index.
4. Run the command below to add DVV triggers to your domain model:

```
# Change the pattern according to your case!
./release r1 YourTableName 'Your-Primary-Key-WHERE-Condition'
cat dvv-functions-r1.sql dvv-triggers-r1.sql > dvv.sql

# DON'T forget to specify DB!
mysql -h SERVER -u USER -p -e 'source dvv.sql' DB
```

### Access MySQL tables from clients

#### INSERT

By default, column `deleted` is FALSE and `logicalClock` is an
initial version vector generated by SQL trigger, you can omit
these columns when insert records.

Loading external data should just work.

#### SELECT

1. Append `where deleted IS FALSE` to SELECT clause or check it after
   retrieval.
2. Always retrieve column `logicalClock` which is a JSON string.
3. If `logicalClock.hasSibling` is true, concurrent updates happended,
   you need reconcile them, follow the "RECONCILE" section below.
4. If the `logicalClock` will be passed to untrusted client, the
   data access layer must encrypt and sign it before passing it.

#### UPDATE

1. Set `logicalClock.dirty` to true, encode `logicalClock` into JSON and
   put it into the UPDATE clause.
2. If exception happens with SQL state '55055', concurrent updates
   happened, you need reconcile them, follow the "RECONCILE" section
   below.

#### DELETE

1. For soft deletion, it's same with UPDATE above, just extra step to
   update `deleted` to true.
2. For hard deletion, follow these steps:
  1. Do soft deletion first.
  2. Issue SQL `SET @i_know_what_i_am_doing='i really want to delete from SomeTable'`,
     change "SomeTable" to real table name for your case.
  3. Issue SQL DELETE clause.
3. When concurrent updates to a row is reconciled successfully, the
   sibling rows in `SomeTable__sibling` will be marked with `deleted = TRUE`,
   you may want to garbage collect those useless rows time to time:
  1. Issue SQL `SET @i_know_what_i_am_doing='i really want to delete from SomeTable__sibling'`,
     change "SomeTable" to real table name for your case.
  2. Issue SQL DELETE clause.

#### RECONCILE

When concurrent updates to a row happened, the siblings of that row are
placed into `SomeTable__sibling`, you need to retrieve all these rows
and merge them according to business rule, then write the result to
MySQL.

1. Issue `SELECT ... FROM SomeTable WHERE id = xxx AND deleted IS FALSE`.
2. Issue `SELECT ... FROM SomeTable__sibling WHERE id = xxx AND deleted IS FALSE`.
3. Merge these rows according to some business rule.
4. Get `logicalClock` from the row **obtained in step 1**, set `logicalClock.hasSibling` to false.
5. Follow the "UPDATE" section.

## MySQL configuration

Besides common configuration for MySQL replication, `binlog-format` must be
set to `STATEMENT` to make this DVV implementation work. Check "replication.conf"
in the same directory for an example.

## References

1. http://basho.com/posts/technical/vector-clocks-revisited/
2. http://basho.com/posts/technical/vector-clocks-revisited-part-2-dotted-version-vectors/
3. https://github.com/basho/riak_core/blob/develop/src/vclock.erl
4. https://github.com/basho/riak_kv/blob/develop/src/riak_object.erl, especially function `update(false, OldObject, NewObject, Actor, Timestamp)`

